<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Decap CMS</title>
  </head>
  <body>
    <!-- Include the script to build the page and provide authentication -->
    <script>
      (function () {
        const LOG_PREFIX = '[Decap OAuth]';
        console.info(`${LOG_PREFIX} Waiting for GitHub authorization messages...`);

        window.addEventListener('message', (event) => {
          if (typeof event.data !== 'string') {
            return;
          }

          if (event.data.startsWith('authorization:github:success:')) {
            try {
              const payloadText = event.data.substring('authorization:github:success:'.length);
              const payload = JSON.parse(payloadText);
              const { token, state, validatedState } = payload;
              
              console.info(
                `${LOG_PREFIX} Received GitHub authorization payload.`,
                { hasToken: !!token },
                state ? { state } : undefined,
                validatedState ? { validatedState } : undefined,
              );

              if (token) {
                // Store the token for Decap CMS in localStorage for persistence
                console.info(`${LOG_PREFIX} Storing OAuth token...`);
                localStorage.setItem('decap-cms-auth-token', token);
                
                // Notify any waiting processes that we have a token
                window.dispatchEvent(new CustomEvent('decap-auth-success', { 
                  detail: { token, state, validatedState } 
                }));
                
                // Reload to reinitialize with the token
                setTimeout(() => {
                  console.info(`${LOG_PREFIX} Reloading to initialize CMS with token...`);
                  window.location.reload();
                }, 100);
              }

            } catch (parseError) {
              console.error(`${LOG_PREFIX} Failed to parse GitHub authorization payload.`, parseError);
            }
          }
        });
      })();
    </script>
    
    <!-- Load Decap CMS -->
    <script src="https://unpkg.com/decap-cms@3.1.10/dist/decap-cms.js"></script>
    
    <script>
      // CMS configuration and initialization
      window.CMS_MANUAL_INIT = true;
      
      function initCMS() {
        const LOG_PREFIX = '[Decap CMS]';
        
        if (typeof window.CMS === 'undefined') {
          console.warn(`${LOG_PREFIX} CMS not available yet, retrying...`);
          setTimeout(initCMS, 200);
          return;
        }

        console.info(`${LOG_PREFIX} Initializing...`);
        
        // Check for stored auth token
        const storedToken = localStorage.getItem('decap-cms-auth-token');
        if (storedToken) {
          console.info(`${LOG_PREFIX} Found stored auth token`);
        }
        
        // Initialize CMS - it will read config.yml automatically
        window.CMS.init();
        
        console.info(`${LOG_PREFIX} Initialization complete`);
      }

      // Start when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initCMS);
      } else {
        initCMS();
      }
    </script>
  </body>
</html>
